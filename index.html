<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Gastos e Ingresos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* === Tu CSS original, recortado por claridad === */
body{font-family:"Segoe UI",Roboto,Arial,sans-serif;background:#f4f6f8;margin:0;padding:20px;color:#333;}
.app{max-width:1100px;margin:auto;background:#fff;border-radius:14px;box-shadow:0 12px 35px rgba(0,0,0,.1);padding:25px 30px 30px;}
h1{text-align:center;margin-top:0;}
.controls{display:flex;justify-content:center;gap:10px;margin-bottom:20px;}
.controls select{padding:10px;font-size:14px;border-radius:8px;border:1px solid #ccc;background:#fff;font-family:inherit;}
.summary{display:flex;gap:12px;margin-bottom:25px;}
.card{flex:1;background:#f9fafb;border-radius:12px;padding:16px;text-align:center;}
.card.ingresos{border-top:4px solid #2ecc71;}
.card.gastos{border-top:4px solid #e74c3c;}
.card.saldo{border-top:4px solid #3498db;}
.card p{font-size:22px;font-weight:700;margin:6px 0 0;}
.form{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-bottom:20px;}
.form input,.form select,.form button{padding:10px;font-size:14px;border-radius:8px;border:1px solid #ccc;}
.form button{grid-column:span 5;background:#3498db;color:#fff;border:none;cursor:pointer;}
.form button:hover{background:#2980b9;}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid #e1e4e8;}
th{background:#f1f3f5;}
td.ingreso{color:#2ecc71;font-weight:600;}
td.gasto{color:#e74c3c;font-weight:600;}
.delete{cursor:pointer;opacity:.6;text-align:center;}
.delete:hover{opacity:1;color:#e74c3c;}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:25px;}
.actions{display:flex;gap:12px;}
.btn{display:flex;align-items:center;gap:8px;padding:10px 18px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:.2s ease;}
.btn-import{background:#ecf0f1;color:#2c3e50;}
.btn-import:hover{background:#dde4e8;}
.btn-export{background:#2c3e50;color:#fff;}
.btn-export:hover{background:#1f2d3a;}
.btn-report{background:#3498db;color:#fff;box-shadow:0 6px 18px rgba(52,152,219,.35);}
.btn-report:hover{background:#2980b9;}
input[type="file"]{display:none;}
</style>
</head>

<body>

<!-- BLOQUE LOGIN -->
<div id="loginDiv" style="text-align:center; margin:50px auto; max-width:300px;">
  <h2>Acceso Control de Gastos</h2>
  <input type="email" id="loginEmail" placeholder="Email" style="width:100%; padding:10px; margin:5px 0; border-radius:8px; border:1px solid #ccc;">
  <input type="password" id="loginPassword" placeholder="Contrase√±a" style="width:100%; padding:10px; margin:5px 0; border-radius:8px; border:1px solid #ccc;">
  <button id="btnLogin" style="width:100%; padding:10px; margin-top:10px; border:none; border-radius:8px; background:#3498db; color:white; cursor:pointer;">Entrar</button>
  <p id="loginError" style="color:red; font-size:14px; margin-top:5px; display:none;"></p>
</div>

<!-- APP -->
<div class="app" style="display:none;">
<h1>Control de Gastos e Ingresos</h1>

<div class="controls">
<select id="mes"></select>
<select id="anio"></select>
</div>

<div class="summary">
<div class="card ingresos"><h3>Ingresos</h3><p id="ingresos">0 ‚Ç¨</p></div>
<div class="card gastos"><h3>Gastos</h3><p id="gastos">0 ‚Ç¨</p></div>
<div class="card saldo"><h3>Saldo</h3><p id="saldo">0 ‚Ç¨</p></div>
</div>

<div class="form">
<input type="date" id="fecha">
<select id="tipo">
<option value="ingreso">Ingreso</option>
<option value="gasto">Gasto</option>
</select>
<input type="number" id="cantidad" step="0.01" placeholder="Importe">
<input type="text" id="concepto" placeholder="Concepto">
<button onclick="agregar()">A√±adir movimiento</button>
</div>

<table>
<thead>
<tr>
<th>Fecha</th>
<th>Concepto</th>
<th>Ingreso</th>
<th>Gasto</th>
<th></th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<div class="footer">
<div class="actions">
<label class="btn btn-import">
IMPORTAR
<input type="file" accept=".csv" onchange="importarCSV(this)">
</label>
<button class="btn btn-export" onclick="exportarCSV()">EXPORTAR</button>
</div>
<button class="btn btn-report" onclick="generarPDF()">INFORME</button>
</div>
</div>

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* Config Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBLqXvnSJs6D5I39xkXUMM3v5xQBMk8lTY",
  authDomain: "control-gastos-65500.firebaseapp.com",
  databaseURL: "https://control-gastos-65500-default-rtdb.firebaseio.com",
  projectId: "control-gastos-65500",
  storageBucket: "control-gastos-65500.firebasestorage.app",
  messagingSenderId: "69402781054",
  appId: "1:69402781054:web:a65b0307b0ac7b88493f2f"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* === LOGIN MANUAL === */
const loginDiv = document.getElementById('loginDiv');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');
const btnLogin = document.getElementById('btnLogin');
const loginError = document.getElementById('loginError');
const appDiv = document.querySelector('.app');

btnLogin.onclick = async () => {
  const email = loginEmail.value.trim();
  const password = loginPassword.value.trim();

  if(!email || !password){
    loginError.textContent = 'Debes ingresar email y contrase√±a.';
    loginError.style.display = 'block';
    return;
  }

  try {
    await auth.signInWithEmailAndPassword(email,password);
    loginError.style.display = 'none';
  } catch(err){
    console.error(err);
    loginError.textContent = 'Email o contrase√±a incorrectos.';
    loginError.style.display = 'block';
  }
};

/* === ON AUTH STATE CHANGE === */
auth.onAuthStateChanged(user=>{
  if(user){
    loginDiv.style.display='none';
    appDiv.style.display='block';
    cargar();
  } else {
    loginDiv.style.display='block';
    appDiv.style.display='none';
  }
});

/* === SELECTS MES/A√ëO === */
const mesSel = document.getElementById('mes');
const anioSel = document.getElementById('anio');
const fecha = document.getElementById('fecha');
const hoy = new Date();
const meses=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
meses.forEach((m,i)=>mesSel.add(new Option(m,i)));
for(let y=hoy.getFullYear()-5;y<=hoy.getFullYear()+5;y++) anioSel.add(new Option(y,y));
mesSel.value=hoy.getMonth();
anioSel.value=hoy.getFullYear();
fecha.valueAsDate = hoy;

/* === FUNCIONES DB === */
async function leerDatos(){
  try{
    const snapshot = await db.ref('finanzas').once('value');
    return snapshot.val() || [];
  }catch(e){
    console.warn("Firebase no disponible, usando copia local");
    return JSON.parse(localStorage.getItem("backup_finanzas")) || [];
  }
}

function guardar(datos){
  db.ref('finanzas').set(datos);
}

/* === FUNCIONES PRINCIPALES === */
async function agregar(){
  const d = await leerDatos();
  d.push({
    fecha: fecha.value,
    tipo: tipo.value,
    cantidad: +cantidad.value,
    concepto: concepto.value
  });
  guardar(d);
  cantidad.value="";
  concepto.value="";
  cargar();
}

async function eliminar(index){
  if(!confirm("¬øEliminar este movimiento?")) return;
  const d = await leerDatos();
  d.splice(index,1);
  guardar(d);
  cargar();
}

async function cargar(){
  const listaCompleta = await leerDatos();
  let i=0,g=0;
  const tabla = document.getElementById('tabla');
  tabla.innerHTML = "";

  const lista = listaCompleta
    .filter(m=>{
      const f=new Date(m.fecha);
      return f.getMonth()==mesSel.value && f.getFullYear()==anioSel.value;
    })
    .sort((a,b)=>new Date(a.fecha)-new Date(b.fecha));

  lista.forEach((m,index)=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`
      <td>${formatearFechaISOaDMY(m.fecha)}</td>
      <td>${m.concepto}</td>
      <td class="ingreso">${m.tipo=="ingreso"?m.cantidad.toFixed(2):""}</td>
      <td class="gasto">${m.tipo=="gasto"?m.cantidad.toFixed(2):""}</td>
      <td class="delete" onclick="eliminar(${index})">üóëÔ∏è</td>
    `;
    tabla.appendChild(tr);
    m.tipo=="ingreso"?i+=m.cantidad:g+=m.cantidad;
  });

  document.getElementById('ingresos').textContent=i.toFixed(2)+" ‚Ç¨";
  document.getElementById('gastos').textContent=g.toFixed(2)+" ‚Ç¨";
  document.getElementById('saldo').textContent=(i-g).toFixed(2)+" ‚Ç¨";

  localStorage.setItem("backup_finanzas",JSON.stringify(listaCompleta));
}

/* === HELPER === */
function formatearFechaISOaDMY(f){
  const [y,m,d] = f.split("-");
  return `${d}/${m}/${y}`;
}

/* === CSV y PDF === */
function exportarCSV(){
  let csv="Fecha;Concepto;Ingreso;Gasto\n";
  leerDatos().then(datos=>{
    datos.forEach(m=>{
      csv+=`${m.fecha};${m.concepto};${m.tipo=="ingreso"?m.cantidad:""};${m.tipo=="gasto"?m.cantidad:""}\n`;
    });
    descargar(csv,"finanzas.csv","text/csv");
  });
}
function importarCSV(input){
  const r = new FileReader();
  r.onload = e=>{
    leerDatos().then(d=>{
      e.target.result.split("\n").slice(1).forEach(l=>{
        if(!l.trim()) return;
        const [f,c,i,g] = l.split(";");
        d.push({fecha:f,concepto:c,tipo:i?"ingreso":"gasto",cantidad:+(i||g)});
      });
      guardar(d); cargar();
    });
  };
  r.readAsText(input.files[0]);
}
function generarPDF(){
  const pdf = new jsPDF("p","mm","a4");
  let y=20;
  pdf.setFontSize(16);
  pdf.setFont("helvetica","bold");
  pdf.text(`INFORME INGRESOS Y GASTO DEL ${meses[mesSel.value].toUpperCase()} ${anioSel.value}`,105,y,{align:"center"});
  y+=12;
  pdf.setFontSize(11); pdf.setFont("helvetica","normal");
  pdf.text(`Total ingresos: ${document.getElementById('ingresos').textContent}`,20,y); y+=6;
  pdf.text(`Total gastos: ${document.getElementById('gastos').textContent}`,20,y); y+=6;
  pdf.text(`Saldo: ${document.getElementById('saldo').textContent}`,20,y);
  y+=12;
  pdf.setFont("helvetica","bold");
  pdf.text("Fecha",20,y); pdf.text("Concepto",50,y);
  pdf.text("Ingreso",135,y,{align:"right"}); pdf.text("Gasto",180,y,{align:"right"});
  y+=4; pdf.line(20,y,190,y); y+=6; pdf.setFont("helvetica","normal");

  leerDatos().then(datos=>{
    datos.filter(m=>{const f=new Date(m.fecha);return f.getMonth()==mesSel.value && f.getFullYear()==anioSel.value;})
    .sort((a,b)=>new Date(a.fecha)-new Date(b.fecha))
    .forEach(m=>{
      if(y>270){pdf.addPage();y=20;}
      pdf.text(formatearFechaISOaDMY(m.fecha),20,y);
      pdf.text(m.concepto.substring(0,45),50,y);
      pdf.text(m.tipo=="ingreso"?m.cantidad.toFixed(2):"",135,y,{align:"right"});
      pdf.text(m.tipo=="gasto"?m.cantidad.toFixed(2):"",180,y,{align:"right"});
      y+=6;
    });
    pdf.save(`Informe_${meses[mesSel.value]}_${anioSel.value}.pdf`);
  });
}

mesSel.onchange=cargar;
anioSel.onchange=cargar;
window.agregar=agregar;
window.eliminar=eliminar;
window.exportarCSV=exportarCSV;
window.importarCSV=importarCSV;
window.generarPDF=generarPDF;

</script>
</body>
</html>
